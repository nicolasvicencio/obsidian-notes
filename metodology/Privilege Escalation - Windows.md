#windows #escalation

Windows NT is the kernel that comes pre-packaged with a few exceptions based on user design philosophy. It consists of two main modes of operation that determine access o system resources and hardware:
- User Mode  - Programs and services running in user mode have limited access to system resources and functionality.
- Kernel Mode - Kernel mode has unrestricted access to system resources and functionality with the added functionality of managing devices and system memory.

Kernel exploit on Windows will typically target vulnerabilities in the Windows kernel to execute arbitrary code in order to run privileged system commands or to obtain s system shell.

Privilege escalation on windows systems will typically follow the following methodology: 
- Identifying kernel vulnerabilities 
- downloading, compiling and transferring kernel exploit onto the target system


### Resources and tools

- https://github.com/AonCyberLabs/Windows-Exploit-Suggester
- https://github.com/SecWiki/windows-kernel-exploits

### Bypassing UAC 

User Account Control (UAC) is a Windows security feature introduced in Windows Vista that is used to prevent, unauthorized changes from being made to the operating system.

A non-privileged user attempting to execute a program with elevated privileges will be prompted with the UAC credential prompt. whereas a privileged user will be prompted with a consent prompt

In order to succesfully bypass UAC, we will need to have access to a user account that is a part of the local administrators group on the windows target system.

We can utilize the Windows Escalate UAC Protection Bypass ( In Memory Injection) module to bypass UAC by utilizing the trusted publisher certificate through process injection. It will spawn a second shell that has the UAC flag turned off.

https://github.com/hfiref0x/UACME

### Windows Access Tokens

Windows Access Tokens are a core element of the authentication process on Windows and are created and managed by the local security authority subsystem services (LSASS)

A windows access token is responsible for identifying and describing the security context of a process or thread running on a system. Simply put in access token can be though of as a temporary key akin to a web cookie that provides users with access to a system or network resource without having to provide credential each time a process is started or system resource is accessed

Access tokens are generated by the winlogon.exe process every time a user authenticates successfully and includes the identity and privileges of the user account associated with the thread or process. This token is then attached to the userinit.exe process, after which all child processes started by a user will inherit a copy of the access token from their creator and will run under the privileges of the same access token 

A access token will typically be assigned one of the following security levels: 
- Impersonate-level tokens are created as a direct result of a non-interactive login on Windows. typically through specific system services or domains logons.
- Delegate level tokens are typically created through and interactive login on windows primary through a traditional login or through remote access protocol such as RDP

Impersonate-level tokens can be used to impersonate a token on the local system and not on any external systems that utilize the token.

Delegate-level tokens pose the largest threat as they can be used to impersonate tokens on any system.

***Privileges required to attack by access tokens:***
- **SeAddignPrimaryToken** This allow a user to impersonate tokens.
- **SeCreateToken** This allow a user to create an arbitrary token with administrative privileges
- **SeImpersonatePrivilege** This allows a user to create a process under the security context of another user typically with administrative privileges.

In metasploit you can 
`load incognito`
`list_tokens -u `
`impersonate_token "<token_name>"`


### [[mimikatz]]

Mimikats is a Windows post-exploitation tool, It allows for the extraction of plain text credentials from memory, password hashes from local SAM databases, and more

We can use the pre-build mimikatz executable alternatively, if we have access to a meterpreter session on a Windows target, we can utilize the inbuilt meterpreter extension Kiwi

`load kiwi`


